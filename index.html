<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tombola Python - Multiplayer Sync</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #306998;
            --secondary: #FFD43B;
            --accent: #4B8BBE;
            --light-bg: #1e1e1e;
            --dark-bg: #121212;
            --card-bg: #252526;
            --text: #f5f5f5;
            --text-secondary: #cccccc;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #f44336;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
            background-image: radial-gradient(circle at 15% 50%, rgba(48, 105, 152, 0.1) 0%, transparent 20%),
                            radial-gradient(circle at 85% 30%, rgba(255, 212, 59, 0.1) 0%, transparent 20%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
            padding: 20px;
        }

        .login-box {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow);
            border-top: 5px solid var(--primary);
        }

        @media (max-width: 768px) {
            .login-box {
                padding: 25px;
            }
        }

        .login-title {
            font-family: 'Source Code Pro', monospace;
            color: var(--secondary);
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        @media (max-width: 768px) {
            .login-title {
                font-size: 1.7rem;
            }
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            background-color: #333;
            border: 2px solid #444;
            border-radius: var(--border-radius);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .input-with-icon {
            position: relative;
        }

        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .input-with-icon input {
            padding-left: 45px;
        }

        /* Game Screen */
        .game-screen {
            display: none;
        }

        header {
            text-align: center;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 5px solid var(--primary);
            border-right: 5px solid var(--secondary);
        }

        @media (max-width: 768px) {
            header {
                padding: 15px;
            }
        }

        h1 {
            font-family: 'Source Code Pro', monospace;
            color: var(--secondary);
            font-size: 2.3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            word-break: break-word;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }
        }

        h1 span {
            color: var(--primary);
        }

        .subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

        .python-logo {
            color: var(--secondary);
            font-size: 1.8rem;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 20px;
        }

        @media (max-width: 992px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .card {
                padding: 15px;
            }
        }

        .card-title {
            font-family: 'Source Code Pro', monospace;
            color: var(--secondary);
            font-size: 1.3rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .card-title {
                font-size: 1.1rem;
            }
        }

        .card-title i {
            color: var(--accent);
        }

        /* Tombola Number Section */
        .number-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            border: 2px dashed var(--accent);
        }

        @media (max-width: 768px) {
            .number-display {
                min-height: 150px;
            }
        }

        .extracted-number {
            font-size: 6rem;
            font-weight: 700;
            color: var(--secondary);
            text-shadow: 0 0 20px rgba(255, 212, 59, 0.5);
            line-height: 1;
            font-family: 'Source Code Pro', monospace;
        }

        @media (max-width: 768px) {
            .extracted-number {
                font-size: 4rem;
            }
        }

        .number-label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 10px;
            text-align: center;
            padding: 0 10px;
        }

        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius);
            font-family: 'Source Code Pro', monospace;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 120px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
                min-width: 110px;
            }
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #555;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #666;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e68a00;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d32f2f;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
        }

        /* Admin Panel */
        .admin-panel {
            background-color: rgba(30, 30, 30, 0.8);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-top: 15px;
            border: 2px solid var(--warning);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .admin-title {
            font-family: 'Source Code Pro', monospace;
            color: var(--warning);
            font-size: 1.1rem;
        }

        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .admin-controls {
                grid-template-columns: 1fr;
            }
        }

        /* Extracted Numbers */
        .extracted-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            min-height: 50px;
            padding: 12px;
            background-color: rgba(30, 30, 30, 0.5);
            border-radius: var(--border-radius);
            justify-content: center;
        }

        .extracted-num {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }

        @media (max-width: 768px) {
            .extracted-num {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
        }

        .extracted-num.recent {
            background-color: var(--secondary);
            color: #333;
            animation: pulse 1s;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Tombola Card */
        .tombola-card {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .tombola-card {
                gap: 4px;
            }
        }

        .number-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #333;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            user-select: none;
            min-height: 35px;
        }

        @media (max-width: 768px) {
            .number-cell {
                font-size: 0.9rem;
                min-height: 30px;
            }
        }

        .number-cell:hover {
            background-color: #444;
        }

        .number-cell.extracted {
            background-color: var(--primary);
            color: white;
            transform: scale(0.95);
        }

        .number-cell.recent {
            background-color: var(--secondary);
            color: #333;
            border-color: var(--secondary);
            animation: highlight 1.5s;
        }

        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(255, 212, 59, 0.7); }
            70% { box-shadow: 0 0 0 8px rgba(255, 212, 59, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 212, 59, 0); }
        }

        .number-cell.empty {
            background-color: transparent;
            cursor: default;
        }

        .number-cell.empty:hover {
            background-color: transparent;
        }

        /* Players */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .players-container {
                grid-template-columns: 1fr;
            }
        }

        .player-card {
            background-color: #333;
            padding: 12px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }

        .player-card.active {
            border-left-color: var(--secondary);
            background-color: #3a3a3a;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .player-card.winner {
            border-left-color: var(--success);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-name {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-card-count {
            background-color: var(--accent);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .player-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }

        .player-num {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #444;
            color: #ddd;
            border-radius: 3px;
            font-size: 0.8rem;
        }

        /* Game Status */
        .game-status {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 12px 15px;
            margin-top: 10px;
            box-shadow: var(--shadow);
        }

        @media (max-width: 768px) {
            .game-status {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
            font-family: 'Source Code Pro', monospace;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .status-value {
                font-size: 1.3rem;
            }
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 3px;
        }

        /* User Info */
        .user-info {
            position: fixed;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--card-bg);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 100;
            max-width: calc(100% - 30px);
        }

        @media (max-width: 768px) {
            .user-info {
                position: static;
                margin-bottom: 15px;
                max-width: 100%;
            }
        }

        .user-role {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .role-admin {
            background-color: var(--warning);
            color: #333;
        }

        .role-player {
            background-color: var(--primary);
            color: white;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.3s;
            flex-shrink: 0;
        }

        .logout-btn:hover {
            color: var(--danger);
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background-color: var(--card-bg);
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .sync-status.connected {
            color: var(--success);
        }

        .sync-status.disconnected {
            color: var(--danger);
        }

        /* Instructions */
        .instructions {
            margin-top: 25px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
        }

        .instructions h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            font-family: 'Source Code Pro', monospace;
            font-size: 1.1rem;
        }

        .instructions ul {
            padding-left: 20px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        @media (min-width: 768px) {
            .instructions ul {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        .instructions li {
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background-color: var(--card-bg);
            width: 100%;
            max-width: 500px;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-top: 5px solid var(--secondary);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            color: var(--secondary);
            font-size: 1.6rem;
            margin-bottom: 15px;
            font-family: 'Source Code Pro', monospace;
        }

        .modal-text {
            margin-bottom: 20px;
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Loader */
        .loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loader-spinner {
            border: 3px solid #333;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Connection Status */
        .connection-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 12px;
            background-color: #333;
            margin-left: 10px;
        }

        .connection-badge.connected {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .connection-badge.disconnected {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--danger);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="container login-container" id="login-screen">
        <div class="login-box">
            <h1 class="login-title"><i class="fab fa-python python-logo"></i> Tombola <span>Python</span></h1>
            <p class="login-subtitle">Accedi con il tuo codice univoco per partecipare al gioco</p>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label">Codice di accesso</label>
                    <div class="input-with-icon">
                        <i class="fas fa-key"></i>
                        <input type="password" class="form-input" id="login-code" placeholder="Es: PLAYER001" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nome giocatore (opzionale)</label>
                    <div class="input-with-icon">
                        <i class="fas fa-user"></i>
                        <input type="text" class="form-input" id="player-name" placeholder="Come vuoi essere chiamato">
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Accedi al Gioco
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 20px; color: var(--text-secondary);">
                    <p>Sei l'amministratore? <a href="#" id="admin-login-link" style="color: var(--warning);">Accedi come admin</a></p>
                </div>
            </form>
            
            <!-- Admin Login -->
            <div id="admin-login-section" style="display: none; margin-top: 30px;">
                <h3 style="color: var(--warning); margin-bottom: 15px; font-family: 'Source Code Pro', monospace;">
                    <i class="fas fa-user-shield"></i> Accesso Admin
                </h3>
                
                <form id="admin-login-form">
                    <div class="form-group">
                        <label class="form-label">Codice Admin</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" class="form-input" id="admin-code" placeholder="Codice admin segreto" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn btn-warning" style="width: 100%;">
                            <i class="fas fa-user-cog"></i> Accedi come Admin
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="back-to-player-login" style="color: var(--accent);">Torna al login giocatore</a>
                    </div>
                </form>
            </div>

            <!-- Loader -->
            <div class="loader" id="login-loader">
                <div class="loader-spinner"></div>
                <p>Connessione al server in corso...</p>
            </div>
        </div>
    </div>
    
    <!-- Game Screen -->
    <div class="container game-screen" id="game-screen">
        <!-- User Info -->
        <div class="user-info" id="user-info">
            <div style="overflow: hidden;">
                <div id="user-display-name" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Giocatore</div>
                <div class="user-role" id="user-role">Giocatore</div>
            </div>
            <div id="connection-status" class="connection-badge disconnected">
                <i class="fas fa-wifi"></i>
                <span>Offline</span>
            </div>
            <button class="logout-btn" id="logout-btn" title="Esci">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        
        <header>
            <h1><i class="fab fa-python python-logo"></i> Tombola <span>Python</span></h1>
            <p class="subtitle" id="game-subtitle">Benvenuto nella tombola online sincronizzata in tempo reale!</p>
            <div class="game-status">
                <div class="status-item">
                    <div class="status-value" id="remaining-numbers">90</div>
                    <div class="status-label">Numeri rimanenti</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="extracted-count">0</div>
                    <div class="status-label">Numeri estratti</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="players-count">0</div>
                    <div class="status-label">Giocatori online</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="current-player">-</div>
                    <div class="status-label">Turno giocatore</div>
                </div>
            </div>
        </header>

        <div class="game-area">
            <div class="card">
                <h2 class="card-title"><i class="fas fa-dice"></i> Estrazione Numeri</h2>
                
                <div class="number-display empty" id="number-display">
                    <div class="number-label">In attesa dell'estrazione...</div>
                </div>
                
                <!-- Admin Controls -->
                <div class="admin-panel" id="admin-controls" style="display: none;">
                    <div class="admin-header">
                        <div class="admin-title"><i class="fas fa-user-cog"></i> Pannello Amministratore</div>
                        <button class="btn btn-secondary btn-sm" id="toggle-codes-btn">
                            <i class="fas fa-key"></i> Gestisci Codici
                        </button>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="btn btn-primary" id="extract-btn">
                            <i class="fas fa-play"></i> Estrai Numero
                        </button>
                        <button class="btn btn-secondary" id="reset-btn">
                            <i class="fas fa-redo"></i> Nuova Partita
                        </button>
                        <button class="btn btn-success" id="auto-btn">
                            <i class="fas fa-robot"></i> Auto Estr.
                        </button>
                    </div>
                    
                    <!-- Code Management -->
                    <div id="code-management" style="display: none; margin-top: 15px;">
                        <h3 style="color: var(--warning); margin-bottom: 10px; font-size: 1.1rem;">
                            <i class="fas fa-key"></i> Gestione Codici Accesso
                        </h3>
                        
                        <div class="admin-controls">
                            <div>
                                <label class="form-label">Numero di codici</label>
                                <input type="number" class="form-input" id="num-codes" min="1" max="50" value="5">
                            </div>
                            <div>
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn-warning" id="generate-codes-btn" style="width: 100%;">
                                    <i class="fas fa-plus-circle"></i> Genera Codici
                                </button>
                            </div>
                        </div>
                        
                        <div class="code-list" id="code-list" style="background-color: #333; border-radius: var(--border-radius); padding: 12px; max-height: 200px; overflow-y: auto; margin-top: 10px;">
                            <!-- Generated codes will appear here -->
                        </div>
                    </div>
                </div>
                
                <!-- Player Controls -->
                <div class="control-buttons" id="player-controls">
                    <div style="text-align: center; width: 100%;">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-info-circle"></i> Solo l'amministratore può estrarre i numeri
                        </p>
                        <p style="color: var(--accent); font-size: 0.85rem;">
                            I numeri estratti vengono sincronizzati automaticamente
                        </p>
                    </div>
                </div>
                
                <h3 class="card-title" style="margin-top: 20px; font-size: 1.1rem;">
                    <i class="fas fa-history"></i> Ultimi Numeri Estratti
                </h3>
                <div class="extracted-numbers" id="extracted-numbers">
                    <!-- I numeri estratti appariranno qui -->
                </div>
            </div>
            
            <div class="card">
                <h2 class="card-title"><i class="fas fa-table"></i> La tua Cartella</h2>
                <p style="margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;" id="player-info-text">
                    Tocca i numeri estratti per segnarli sulla tua cartella
                </p>
                
                <div class="tombola-card" id="tombola-card">
                    <!-- La cartella della tombola sarà generata qui -->
                </div>
                
                <div style="margin-top: 20px;">
                    <div class="player-header" style="margin-bottom: 10px;">
                        <h3 class="card-title" style="font-size: 1.1rem; margin: 0; border: none; padding: 0;">
                            <i class="fas fa-users"></i> Giocatori Online
                        </h3>
                        <div id="players-online-count" class="player-card-count">0</div>
                    </div>
                    <div class="players-container" id="players-container">
                        <!-- I giocatori saranno generati qui -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> Come funziona</h3>
            <ul>
                <li><strong>Admin</strong>: Estrae numeri che tutti i giocatori vedono in tempo reale</li>
                <li><strong>Giocatori</strong>: Segnano i numeri estratti sulla propria cartella</li>
                <li><strong>Vittoria</strong>: Vince chi completa per primo una riga, colonna o tutta la cartella</li>
                <li><strong>Codici</strong>: L'admin genera codici univoci per i giocatori</li>
                <li><strong>Sync</strong>: Tutti vedono gli stessi numeri estratti in tempo reale</li>
            </ul>
        </div>

        <!-- Sync Status -->
        <div class="sync-status connected" id="sync-status">
            <i class="fas fa-sync-alt fa-spin"></i>
            <span>Sincronizzazione in tempo reale attiva</span>
        </div>
    </div>

    <!-- Modal per il vincitore -->
    <div class="modal" id="winner-modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-trophy"></i> Tombola!</h2>
            <p class="modal-text" id="winner-text">Un giocatore ha completato la cartella e ha vinto la partita!</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="close-modal-btn">Continua a giocare</button>
                <button class="btn btn-primary" id="new-game-btn">Nuova Partita</button>
            </div>
        </div>
    </div>

    <!-- Modal per i codici generati -->
    <div class="modal" id="codes-modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-key"></i> Codici Generati</h2>
            <p class="modal-text">Ecco i codici di accesso per i giocatori. Condividili con loro:</p>
            <div id="generated-codes-list" style="background-color: #333; padding: 12px; border-radius: var(--border-radius); margin-bottom: 15px; max-height: 300px; overflow-y: auto; font-family: 'Source Code Pro', monospace;">
                <!-- Generated codes will appear here -->
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="close-codes-modal-btn">Chiudi</button>
                <button class="btn btn-primary" id="copy-codes-btn">
                    <i class="fas fa-copy"></i> Copia Codici
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per errori di connessione -->
    <div class="modal" id="error-modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Errore di Connessione</h2>
            <p class="modal-text" id="error-text">Si è verificato un errore nella connessione al server.</p>
            <div class="modal-buttons">
                <button class="btn btn-primary" id="reconnect-btn">Riconnetti</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DI SINCRONIZZAZIONE IN TEMPO REALE
        // ============================================

        // Configurazione
        const CONFIG = {
            ADMIN_CODE: "PYTHON2024",
            MAX_PLAYERS: 20,
            SYNC_INTERVAL: 2000, // 2 secondi
            RECONNECT_DELAY: 5000, // 5 secondi
            API_URL: "", // Per Render, useremo localStorage come "server"
            VERSION: "1.0.0"
        };

        // Stato del gioco GLOBALE (condiviso tra tutti)
        let globalGameState = {
            extractedNumbers: [],
            remainingNumbers: Array.from({length: 90}, (_, i) => i + 1),
            gameActive: false,
            players: [],
            adminConnected: false,
            lastUpdate: Date.now(),
            gameId: "tombola_" + Date.now()
        };

        // Stato dell'utente corrente
        let currentUser = {
            isLoggedIn: false,
            role: null,
            code: null,
            name: null,
            playerId: null,
            lastSync: 0
        };

        // Database locale per codici
        let gameDatabase = {
            generatedCodes: [],
            activeSessions: []
        };

        // Intervallo di sincronizzazione
        let syncInterval = null;
        let connectionStatus = false;

        // ============================================
        // SISTEMA DI SINCRONIZZAZIONE
        // ============================================

        // Inizializza il sistema di sync
        function initSyncSystem() {
            // Carica lo stato dal localStorage
            loadGlobalState();
            
            // Avvia il sync
            startSync();
            
            // Setup periodic sync
            syncInterval = setInterval(() => {
                syncGameState();
            }, CONFIG.SYNC_INTERVAL);
        }

        // Carica lo stato globale
        function loadGlobalState() {
            try {
                const saved = localStorage.getItem('tombola_global_state');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    
                    // Mantieni solo se è recente (ultimi 5 minuti)
                    if (parsed.lastUpdate && (Date.now() - parsed.lastUpdate) < 5 * 60 * 1000) {
                        globalGameState = parsed;
                        console.log("Stato globale caricato:", globalGameState);
                    }
                }
                
                // Carica database codici
                const savedCodes = localStorage.getItem('tombola_codes');
                if (savedCodes) {
                    gameDatabase.generatedCodes = JSON.parse(savedCodes);
                }
                
                updateConnectionStatus(true);
            } catch (e) {
                console.error("Errore nel caricamento dello stato:", e);
            }
        }

        // Salva lo stato globale
        function saveGlobalState() {
            try {
                globalGameState.lastUpdate = Date.now();
                localStorage.setItem('tombola_global_state', JSON.stringify(globalGameState));
                localStorage.setItem('tombola_codes', JSON.stringify(gameDatabase.generatedCodes));
                updateConnectionStatus(true);
            } catch (e) {
                console.error("Errore nel salvataggio:", e);
                updateConnectionStatus(false);
            }
        }

        // Sincronizza lo stato del gioco
        function syncGameState() {
            if (!currentUser.isLoggedIn) return;
            
            try {
                // Aggiorna lo stato locale con quello globale
                const saved = localStorage.getItem('tombola_global_state');
                if (saved) {
                    const remoteState = JSON.parse(saved);
                    
                    // Se lo stato remoto è più recente, aggiorna
                    if (remoteState.lastUpdate > globalGameState.lastUpdate) {
                        globalGameState = remoteState;
                        updateUIFromGlobalState();
                    }
                }
                
                // Salva il proprio stato se si è admin
                if (currentUser.role === 'admin' && globalGameState.adminConnected) {
                    saveGlobalState();
                }
                
                // Aggiorna lo stato del giocatore corrente
                updateCurrentPlayerStatus();
                
                updateConnectionStatus(true);
            } catch (e) {
                console.error("Errore nella sincronizzazione:", e);
                updateConnectionStatus(false);
            }
        }

        // Inizia il sistema di sync
        function startSync() {
            console.log("Sistema di sincronizzazione avviato");
            updateConnectionStatus(true);
        }

        // Aggiorna lo stato della connessione
        function updateConnectionStatus(connected) {
            connectionStatus = connected;
            const statusElement = document.getElementById('connection-status');
            
            if (connected) {
                statusElement.className = 'connection-badge connected';
                statusElement.innerHTML = '<i class="fas fa-wifi"></i><span>Online</span>';
                document.getElementById('sync-status').style.display = 'flex';
            } else {
                statusElement.className = 'connection-badge disconnected';
                statusElement.innerHTML = '<i class="fas fa-wifi-slash"></i><span>Offline</span>';
                document.getElementById('sync-status').style.display = 'none';
            }
        }

        // ============================================
        // GESTIONE UTENTI E LOGIN
        // ============================================

        // Genera codici di accesso
        function generateAccessCodes(count) {
            const newCodes = [];
            
            for (let i = 0; i < count; i++) {
                const code = "PLAYER" + String(gameDatabase.generatedCodes.length + i + 1).padStart(3, '0');
                
                newCodes.push({
                    code: code,
                    used: false,
                    playerName: "",
                    generatedAt: new Date().toISOString()
                });
            }
            
            gameDatabase.generatedCodes = [...gameDatabase.generatedCodes, ...newCodes];
            saveGlobalState();
            updateCodeListDisplay();
            
            return newCodes;
        }

        // Verifica il codice di accesso
        function verifyAccessCode(code, isAdminLogin = false) {
            if (isAdminLogin) {
                return code === CONFIG.ADMIN_CODE;
            } else {
                const codeEntry = gameDatabase.generatedCodes.find(entry => entry.code === code);
                return codeEntry ? true : false;
            }
        }

        // Effettua il login
        function loginUser(code, playerName = "", isAdmin = false) {
            showLoader(true);
            
            setTimeout(() => {
                if (isAdmin) {
                    currentUser = {
                        isLoggedIn: true,
                        role: "admin",
                        code: code,
                        name: playerName || "Amministratore",
                        playerId: "admin_" + Date.now(),
                        lastSync: Date.now()
                    };
                    
                    globalGameState.adminConnected = true;
                    saveGlobalState();
                    
                    updateUIForGame();
                    showNotification("Accesso admin effettuato!", "success");
                } else {
                    // Trova il codice
                    const codeEntry = gameDatabase.generatedCodes.find(entry => entry.code === code);
                    
                    if (!codeEntry) {
                        showNotification("Codice non valido", "error");
                        showLoader(false);
                        return false;
                    }
                    
                    // Aggiorna il codice se non usato
                    if (!codeEntry.used) {
                        codeEntry.used = true;
                        codeEntry.playerName = playerName || `Giocatore ${globalGameState.players.length + 1}`;
                        codeEntry.usedAt = new Date().toISOString();
                    }
                    
                    const playerId = "player_" + Date.now() + "_" + Math.random().toString(36).substr(2, 6);
                    
                    currentUser = {
                        isLoggedIn: true,
                        role: "player",
                        code: code,
                        name: playerName || codeEntry.playerName,
                        playerId: playerId,
                        lastSync: Date.now()
                    };
                    
                    // Aggiungi/aggiorna il giocatore nello stato globale
                    const existingPlayerIndex = globalGameState.players.findIndex(p => p.code === code);
                    
                    if (existingPlayerIndex === -1) {
                        // Nuovo giocatore
                        const playerNumbers = generateRandomNumbers(15, 1, 90);
                        
                        const newPlayer = {
                            id: playerId,
                            code: code,
                            name: currentUser.name,
                            numbers: playerNumbers,
                            extractedCount: 0,
                            isActive: true,
                            hasWon: false,
                            joinedAt: new Date().toISOString(),
                            lastActivity: Date.now()
                        };
                        
                        globalGameState.players.push(newPlayer);
                    } else {
                        // Giocatore esistente (riconnessione)
                        globalGameState.players[existingPlayerIndex].isActive = true;
                        globalGameState.players[existingPlayerIndex].lastActivity = Date.now();
                    }
                    
                    saveGlobalState();
                    updateUIForGame();
                    showNotification(`Benvenuto ${currentUser.name}!`, "success");
                }
                
                showLoader(false);
                return true;
            }, 500);
        }

        // Logout
        function logoutUser() {
            if (currentUser.role === "player") {
                const playerIndex = globalGameState.players.findIndex(p => p.code === currentUser.code);
                if (playerIndex !== -1) {
                    globalGameState.players[playerIndex].isActive = false;
                }
            } else if (currentUser.role === "admin") {
                globalGameState.adminConnected = false;
            }
            
            saveGlobalState();
            
            currentUser = {
                isLoggedIn: false,
                role: null,
                code: null,
                name: null,
                playerId: null
            };
            
            updateUIForLogin();
            showNotification("Logout effettuato", "info");
        }

        // ============================================
        // LOGICA DEL GIOCO
        // ============================================

        // Genera numeri casuali
        function generateRandomNumbers(count, min, max) {
            const numbers = new Set();
            while (numbers.size < count) {
                numbers.add(Math.floor(Math.random() * (max - min + 1)) + min);
            }
            return Array.from(numbers).sort((a, b) => a - b);
        }

        // Estrai numero (solo admin)
        function extractNumber() {
            if (!globalGameState.gameActive || globalGameState.remainingNumbers.length === 0) return;
            
            const randomIndex = Math.floor(Math.random() * globalGameState.remainingNumbers.length);
            const extractedNumber = globalGameState.remainingNumbers[randomIndex];
            
            globalGameState.remainingNumbers.splice(randomIndex, 1);
            globalGameState.extractedNumbers.push(extractedNumber);
            
            // Notifica tutti i giocatori
            showNotification(`Estratto il numero ${extractedNumber}!`, "success");
            
            // Aggiorna l'UI
            updateNumberDisplay(extractedNumber);
            updateExtractedNumbersDisplay();
            updateGameStatus();
            updatePlayersDisplay();
            
            // Controlla vincitore
            checkForWinner();
            
            // Salva lo stato globale
            saveGlobalState();
        }

        // Inizia nuova partita
        function startNewGame() {
            globalGameState.extractedNumbers = [];
            globalGameState.remainingNumbers = Array.from({length: 90}, (_, i) => i + 1);
            globalGameState.gameActive = true;
            
            // Rigenera cartelle per tutti i giocatori
            globalGameState.players.forEach(player => {
                player.numbers = generateRandomNumbers(15, 1, 90);
                player.extractedCount = 0;
                player.hasWon = false;
            });
            
            // Aggiorna UI
            updateNumberDisplay(null);
            updateExtractedNumbersDisplay();
            updateGameStatus();
            updatePlayersDisplay();
            
            if (currentUser.role === "player") {
                createTombolaCard();
            }
            
            saveGlobalState();
            showNotification("Nuova partita iniziata!", "success");
            
            // Chiudi eventuale modal
            document.getElementById('winner-modal').style.display = 'none';
        }

        // Controlla se c'è un vincitore
        function checkForWinner() {
            globalGameState.players.forEach(player => {
                if (player.hasWon) return;
                
                const extractedCount = player.numbers.filter(num => 
                    globalGameState.extractedNumbers.includes(num)
                ).length;
                
                player.extractedCount = extractedCount;
                
                // Vincita: 15 numeri (cartella completa)
                if (extractedCount === 15) {
                    player.hasWon = true;
                    globalGameState.gameActive = false;
                    
                    showWinnerModal(player);
                    saveGlobalState();
                }
            });
        }

        // ============================================
        // INTERFACCIA UTENTE
        // ============================================

        // Mostra/nascondi loader
        function showLoader(show) {
            document.getElementById('login-loader').style.display = show ? 'block' : 'none';
        }

        // Mostra notifica
        function showNotification(message, type = "info") {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 20px;
                background-color: ${type === "success" ? "var(--success)" : 
                                 type === "error" ? "var(--danger)" : 
                                 type === "warning" ? "var(--warning)" : "var(--primary)"};
                color: white;
                border-radius: var(--border-radius);
                box-shadow: var(--shadow);
                z-index: 2000;
                font-weight: 500;
                animation: slideDown 0.3s ease;
                max-width: 90%;
                text-align: center;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = "slideUp 0.3s ease";
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
            
            // Aggiungi le animazioni se non esistono
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideDown {
                        from { top: -50px; opacity: 0; }
                        to { top: 20px; opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { top: 20px; opacity: 1; }
                        to { top: -50px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Aggiorna UI dallo stato globale
        function updateUIFromGlobalState() {
            updateNumberDisplay(globalGameState.extractedNumbers.length > 0 ? 
                globalGameState.extractedNumbers[globalGameState.extractedNumbers.length - 1] : null);
            updateExtractedNumbersDisplay();
            updateGameStatus();
            updatePlayersDisplay();
            
            if (currentUser.role === "player") {
                createTombolaCard();
            }
        }

        // Aggiorna stato giocatore corrente
        function updateCurrentPlayerStatus() {
            if (currentUser.role === "player") {
                const player = globalGameState.players.find(p => p.code === currentUser.code);
                if (player) {
                    player.lastActivity = Date.now();
                }
            }
        }

        // Crea cartella tombola
        function createTombolaCard() {
            const tombolaCard = document.getElementById('tombola-card');
            tombolaCard.innerHTML = '';
            
            const player = globalGameState.players.find(p => p.code === currentUser.code);
            if (!player) return;
            
            const playerNumbers = player.numbers;
            
            for (let i = 0; i < 27; i++) {
                const cell = document.createElement('div');
                cell.className = 'number-cell';
                
                const row = Math.floor(i / 9);
                const col = i % 9;
                const minNum = col * 10 + 1;
                const maxNum = col * 10 + 10;
                
                const colNumbers = playerNumbers.filter(num => num >= minNum && num <= maxNum);
                
                if (row < colNumbers.length) {
                    const number = colNumbers[row];
                    cell.textContent = number;
                    cell.dataset.number = number;
                    
                    if (globalGameState.extractedNumbers.includes(number)) {
                        cell.classList.add('extracted');
                        
                        if (globalGameState.extractedNumbers.length > 0 && 
                            globalGameState.extractedNumbers[globalGameState.extractedNumbers.length - 1] === number) {
                            cell.classList.add('recent');
                        }
                    }
                    
                    cell.addEventListener('click', () => {
                        if (globalGameState.extractedNumbers.includes(number)) {
                            cell.classList.toggle('extracted');
                        }
                    });
                } else {
                    cell.classList.add('empty');
                }
                
                tombolaCard.appendChild(cell);
            }
        }

        // Aggiorna display numero estratto
        function updateNumberDisplay(number) {
            const numberDisplay = document.getElementById('number-display');
            
            if (number === null) {
                numberDisplay.innerHTML = '<div class="number-label">Nessun numero estratto</div>';
                numberDisplay.classList.add('empty');
            } else {
                numberDisplay.innerHTML = `
                    <div class="extracted-number">${number}</div>
                    <div class="number-label">Numero estratto</div>
                `;
                numberDisplay.classList.remove('empty');
            }
        }

        // Aggiorna numeri estratti
        function updateExtractedNumbersDisplay() {
            const container = document.getElementById('extracted-numbers');
            container.innerHTML = '';
            
            const recentNumbers = globalGameState.extractedNumbers.slice(-15);
            
            recentNumbers.forEach((num, index) => {
                const numElement = document.createElement('div');
                numElement.className = 'extracted-num';
                if (index === recentNumbers.length - 1 && globalGameState.extractedNumbers.length > 0) {
                    numElement.classList.add('recent');
                }
                numElement.textContent = num;
                container.appendChild(numElement);
            });
            
            if (currentUser.role === "player") {
                createTombolaCard();
            }
        }

        // Aggiorna stato gioco
        function updateGameStatus() {
            document.getElementById('remaining-numbers').textContent = globalGameState.remainingNumbers.length;
            document.getElementById('extracted-count').textContent = globalGameState.extractedNumbers.length;
            
            const activePlayers = globalGameState.players.filter(p => p.isActive).length;
            document.getElementById('players-count').textContent = activePlayers;
            document.getElementById('players-online-count').textContent = activePlayers;
            
            // Turno corrente (semplificato)
            const currentTurn = activePlayers > 0 ? (globalGameState.extractedNumbers.length % activePlayers) + 1 : '-';
            document.getElementById('current-player').textContent = currentTurn;
        }

        // Aggiorna display giocatori
        function updatePlayersDisplay() {
            const container = document.getElementById('players-container');
            const activePlayers = globalGameState.players.filter(p => p.isActive);
            
            if (activePlayers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                        <p>Nessun giocatore online</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            activePlayers.forEach(player => {
                const extractedCount = player.numbers.filter(num => 
                    globalGameState.extractedNumbers.includes(num)
                ).length;
                
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                if (player.code === currentUser.code) playerCard.classList.add('active');
                if (player.hasWon) playerCard.classList.add('winner');
                
                playerCard.innerHTML = `
                    <div class="player-header">
                        <div class="player-name">
                            ${player.hasWon ? '<i class="fas fa-trophy" style="color: var(--success);"></i>' : ''}
                            ${player.code === currentUser.code ? 
                                '<i class="fas fa-user" style="color: var(--secondary);"></i>' : 
                                '<i class="far fa-user"></i>'}
                            ${player.name}
                        </div>
                        <div class="player-card-count">${extractedCount}/15</div>
                    </div>
                    <div class="player-numbers">
                        ${player.numbers.slice(0, 6).map(num => {
                            const isExtracted = globalGameState.extractedNumbers.includes(num);
                            return `<div class="player-num ${isExtracted ? 'extracted' : ''}">${num}</div>`;
                        }).join('')}
                        ${player.numbers.length > 6 ? '<div class="player-num">...</div>' : ''}
                    </div>
                `;
                
                container.appendChild(playerCard);
            });
        }

        // Aggiorna lista codici
        function updateCodeListDisplay() {
            const codeList = document.getElementById('code-list');
            const codes = gameDatabase.generatedCodes;
            
            if (codes.length === 0) {
                codeList.innerHTML = `
                    <div style="text-align: center; padding: 15px; color: var(--text-secondary);">
                        <i class="fas fa-key" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                        <p>Nessun codice generato</p>
                    </div>
                `;
                return;
            }
            
            codeList.innerHTML = '';
            
            codes.forEach(codeObj => {
                const codeElement = document.createElement('div');
                codeElement.style.cssText = `
                    padding: 8px;
                    margin-bottom: 6px;
                    background-color: #222;
                    border-radius: 4px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                codeElement.innerHTML = `
                    <div>
                        <div style="font-family: 'Source Code Pro', monospace; font-size: 0.9rem;">${codeObj.code}</div>
                        ${codeObj.playerName ? 
                            `<div style="font-size: 0.8rem; color: var(--accent);">${codeObj.playerName}</div>` : ''}
                    </div>
                    <div style="font-size: 0.8rem; padding: 2px 6px; border-radius: 3px; 
                        background-color: ${codeObj.used ? 'var(--danger)' : 'var(--success)'}; 
                        color: white;">
                        ${codeObj.used ? 'Usato' : 'Disponibile'}
                    </div>
                `;
                
                codeList.appendChild(codeElement);
            });
        }

        // Mostra vincitore
        function showWinnerModal(winner) {
            const modal = document.getElementById('winner-modal');
            const winnerText = document.getElementById('winner-text');
            
            winnerText.textContent = `🎉 ${winner.name} ha completato la cartella e ha vinto la partita! 🎉`;
            modal.style.display = 'flex';
        }

        // Mostra codici generati
        function showGeneratedCodes(codes) {
            const modal = document.getElementById('codes-modal');
            const codesList = document.getElementById('generated-codes-list');
            
            codesList.innerHTML = '';
            
            codes.forEach(codeObj => {
                const codeElement = document.createElement('div');
                codeElement.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    background-color: #222;
                    border-radius: 4px;
                    font-family: 'Source Code Pro', monospace;
                    font-size: 0.9rem;
                `;
                codeElement.textContent = `${codeObj.code} - ${codeObj.used ? 'Usato' : 'Disponibile'}`;
                codesList.appendChild(codeElement);
            });
            
            modal.style.display = 'flex';
        }

        // Aggiorna UI per login
        function updateUIForLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('game-screen').style.display = 'none';
            
            // Pulisci campi
            document.getElementById('login-code').value = '';
            document.getElementById('player-name').value = '';
            document.getElementById('admin-code').value = '';
            document.getElementById('admin-login-section').style.display = 'none';
            
            showLoader(false);
        }

        // Aggiorna UI per gioco
        function updateUIForGame() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            // Aggiorna info utente
            document.getElementById('user-display-name').textContent = currentUser.name;
            document.getElementById('user-role').textContent = currentUser.role === "admin" ? "Amministratore" : "Giocatore";
            document.getElementById('user-role').className = `user-role role-${currentUser.role}`;
            
            // Configura UI in base al ruolo
            if (currentUser.role === "admin") {
                document.getElementById('game-subtitle').textContent = "Sei l'amministratore. Estrai numeri e gestisci il gioco.";
                document.getElementById('admin-controls').style.display = 'block';
                document.getElementById('player-controls').style.display = 'none';
                document.getElementById('player-info-text').textContent = "Come amministratore, controlli il gioco.";
                
                // Se admin, inizializza subito una partita se non attiva
                if (!globalGameState.gameActive) {
                    globalGameState.gameActive = true;
                    saveGlobalState();
                }
                
                updateCodeListDisplay();
            } else {
                document.getElementById('game-subtitle').textContent = `Benvenuto ${currentUser.name}! Segui i numeri estratti.`;
                document.getElementById('admin-controls').style.display = 'none';
                document.getElementById('player-controls').style.display = 'block';
                document.getElementById('player-info-text').textContent = "Tocca i numeri estratti per segnarli sulla tua cartella.";
                
                createTombolaCard();
            }
            
            updateUIFromGlobalState();
        }

        // ============================================
        // INIZIALIZZAZIONE
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            // Inizializza sistema sync
            initSyncSystem();
            
            // Setup event listeners
            setupEventListeners();
            
            // Genera alcuni codici di esempio se vuoto
            if (gameDatabase.generatedCodes.length === 0) {
                generateAccessCodes(5);
            }
        });

        // Setup event listeners
        function setupEventListeners() {
            // Login player
            document.getElementById('login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const code = document.getElementById('login-code').value.trim().toUpperCase();
                const playerName = document.getElementById('player-name').value.trim();
                
                if (!code) {
                    showNotification("Inserisci un codice di accesso", "error");
                    return;
                }
                
                if (verifyAccessCode(code, false)) {
                    loginUser(code, playerName || `Giocatore ${globalGameState.players.length + 1}`, false);
                } else {
                    showNotification("Codice non valido. Controlla o chiedi all'admin.", "error");
                }
            });
            
            // Admin login link
            document.getElementById('admin-login-link').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('admin-login-section').style.display = 'block';
            });
            
            // Back to player login
            document.getElementById('back-to-player-login').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('admin-login-section').style.display = 'none';
            });
            
            // Admin login form
            document.getElementById('admin-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const adminCode = document.getElementById('admin-code').value.trim();
                
                if (!adminCode) {
                    showNotification("Inserisci il codice admin", "error");
                    return;
                }
                
                if (verifyAccessCode(adminCode, true)) {
                    loginUser(adminCode, "Amministratore", true);
                } else {
                    showNotification("Codice admin non valido", "error");
                }
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            // Game controls (admin only)
            document.getElementById('extract-btn').addEventListener('click', extractNumber);
            document.getElementById('reset-btn').addEventListener('click', () => {
                if (confirm("Vuoi iniziare una nuova partita? Tutti i progressi andranno persi.")) {
                    startNewGame();
                }
            });
            
            // Auto extract toggle
            document.getElementById('auto-btn').addEventListener('click', () => {
                const btn = document.getElementById('auto-btn');
                if (btn.dataset.auto === 'on') {
                    clearInterval(window.autoExtractInterval);
                    btn.dataset.auto = 'off';
                    btn.innerHTML = '<i class="fas fa-robot"></i> Auto Estr.';
                    showNotification("Auto-estrazione disattivata", "info");
                } else {
                    btn.dataset.auto = 'on';
                    btn.innerHTML = '<i class="fas fa-stop"></i> Ferma Auto';
                    window.autoExtractInterval = setInterval(() => {
                        if (globalGameState.gameActive && globalGameState.remainingNumbers.length > 0) {
                            extractNumber();
                        } else {
                            clearInterval(window.autoExtractInterval);
                            btn.dataset.auto = 'off';
                            btn.innerHTML = '<i class="fas fa-robot"></i> Auto Estr.';
                        }
                    }, 1500);
                    showNotification("Auto-estrazione attivata", "success");
                }
            });
            
            // Code management
            document.getElementById('toggle-codes-btn').addEventListener('click', () => {
                const codeManagement = document.getElementById('code-management');
                codeManagement.style.display = codeManagement.style.display === 'none' ? 'block' : 'none';
            });
            
            document.getElementById('generate-codes-btn').addEventListener('click', () => {
                const numCodes = parseInt(document.getElementById('num-codes').value) || 5;
                if (numCodes < 1 || numCodes > 50) {
                    showNotification("Inserisci un numero tra 1 e 50", "error");
                    return;
                }
                
                const newCodes = generateAccessCodes(numCodes);
                showGeneratedCodes(newCodes);
                showNotification(`${numCodes} nuovi codici generati!`, "success");
            });
            
            // Modal buttons
            document.getElementById('close-modal-btn').addEventListener('click', () => {
                document.getElementById('winner-modal').style.display = 'none';
            });
            
            document.getElementById('new-game-btn').addEventListener('click', () => {
                document.getElementById('winner-modal').style.display = 'none';
                startNewGame();
            });
            
            document.getElementById('close-codes-modal-btn').addEventListener('click', () => {
                document.getElementById('codes-modal').style.display = 'none';
            });
            
            document.getElementById('copy-codes-btn').addEventListener('click', () => {
                const codes = gameDatabase.generatedCodes.map(c => c.code).join('\n');
                navigator.clipboard.writeText(codes)
                    .then(() => showNotification("Codici copiati negli appunti!", "success"))
                    .catch(() => showNotification("Errore nella copia", "error"));
            });
        }
    </script>
</body>
</html>
